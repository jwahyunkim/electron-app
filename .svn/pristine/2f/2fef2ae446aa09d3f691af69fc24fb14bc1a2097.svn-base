import saveIcon from "@ui5/webcomponents-icons/dist/save.js";
import { useState, useEffect, useRef, useMemo  } from "react";
import axios from "axios";
import {
  Text,
  Button,
  Dialog,
  Toast,
} from "@ui5/webcomponents-react";
import "@sap-ui/common-css/dist/sap-content-paddings.css";
import "@sap-ui/common-css/dist/sap-container-type.css";


import okGreen from "@renderer/resources/E_Confirm_Ok.png";
import okOrange from "@renderer/resources/E_Confirm_Orange.png";
import okDodgerblue from "@renderer/resources/E_Confirm_Dodgerblue.png";
import okYellow from "@renderer/resources/E_Confirm_Yellow.png";
import okWhite from "@renderer/resources/E_Confirm_White.png";

import './index.css'; 
import { SAP_CONFIG, getAccessToken, refreshToken } from "@shared/sap";
import { loadConfigClient } from "../utils/loadConfigClient";
import type { DbConfig } from "../utils/loadConfigClient";

interface TableRow {
  stt: string;
  flag: string;
  c1_Qty: string;
  c1_Confirm_Yn: string;
  c1_Ps_Id: string;
  c2_qty: string;
  c2_Confirm_Yn: string;
  c2_Ps_Id: string;
}

interface CardItem {
  seq: number;
  qty: number;
  input_dt: string;
  prod_dt: string;
  confirm_YN: string;
  flag: string;
  sfc?: string;
  operation?: string;
  resource?: string;
  // ‚úÖ Ï∂îÍ∞Ä ÌïÑÎìúÎì§
  SCAN_TYPE?: string;
  PCARD_QTY?: number;

  // ‚úÖ ÏõêÎ≥∏ ÌïÑÎìú (optional)
  q_quantity?: number;
  q_status_code?: string;
  q_sfc?: string;

  // ‚úÖ  mappedSFCÎäî SEQÎ≥ÑÎ°ú SFCÎ•º Îß§ÌïëÌïòÍ∏∞ ÏúÑÌïú ÌïÑÎìú 
  mappedSFC?: string;
}

interface SavePayloadItem {
  PLANT_CD: string;
  WORK_CENTER: string;
  ORDER_NUMBER: string;
  SEQ: string;
  MATERIAL_CODE: string;
  SIZE_CD: string;
  ITPO_TYPE: string;
  SFC: string;
  SCAN_TYPE: string;
  PCARD_QTY: number;
  USER_IP: string;
  DEVICE_ID: string;
}

interface Props {
  open: boolean;
  onClose: () => void;
  data: any;
  cellInfo: any;
  rows: TableRow[];
  onConfirm: (data: any[]) => void;
  plant_cd: string; // ‚úÖ Ï∂îÍ∞Ä
  work_date: string;
}

interface RoutingMaterial {
  material: string;
  version: string;
}
interface RoutingStepComponent {
  bomComponent?: {
    material?: RoutingMaterial;
  };
  quantity?: number; 
}
interface RoutingStep {
  routingStepComponentList?: RoutingStepComponent[];
}

interface BomComponent {
  material?: {
    material: string;
    version: string;
  };
  quantity: number;
  totalQuantity?: number; // ‚úÖ Ïù¥Í±∞ Ï∂îÍ∞Ä
  unitOfMeasure?: string; // ‚úÖ Ïù¥ Ï§ÑÏùÑ Ï∂îÍ∞Ä
  storageLocation?: string;
}

interface AutoActivityConfirmParams {
  plant: string;
  shopOrder: string;
  sfc: string;
  operationActivity: string;
  operationActivityVersion: string;
  stepId: string;
  workCenter: string;
  resource: string;
  routingId: string;
  finalConfirmation?: boolean;
  postConfirmationToErp?: boolean;
  postedBy: string;
  postingDateTime: string; // ISO format, e.g. '2025-07-08T09:00:00.000Z'
}



export function E_ScanOutgoing_Detail({ open, onClose, data, cellInfo, rows, onConfirm, plant_cd, work_date }: Props) {
  const [cardData, setCardData] = useState<CardItem[]>([]);
  const originalCardDataRef = useRef<CardItem[]>([]);
  const [toastMessage, setToastMessage] = useState("");
  const [toastOpen, setToastOpen] = useState(false);
  const [currentPage, setCurrentPage] = useState(1);
  const [isButtonEnabled, setIsButtonEnabled] = useState(true);
  const [isSfcMode, setIsSfcMode] = useState(false);
  const [minValidSfc, setMinValidSfc] = useState<string | null>(null); // ‚úÖ Ï∂îÍ∞Ä
  const orderedSfcListRef = useRef<string[]>([]);
  const stableSfc = useMemo(() => {
    return typeof data?.SFC === "string" ? data.SFC : "";
  }, [data]);
  const [localIp, setLocalIp] = useState<string>("");
  const [externalIp, setExternalIp] = useState<string>("");
  const [config, setConfig] = useState<DbConfig | null>(null);

  type FilterKey = 'notStarted' | 'inProgress' | 'completed';

  const filterOptions: { key: FilterKey; label: string }[] = [
    { key: 'notStarted', label: 'ÎØ∏ÏßÑÌñâ' },
    { key: 'inProgress', label: 'ÏßÑÌñâÏ§ë' },
    { key: 'completed', label: 'ÏôÑÎ£å' }
  ];

  const itemsPerPage = 8; // Ïπ¥Îìú 8Í∞úÏî©


  const [checkedStates, setCheckedStates] = useState<Record<FilterKey, boolean>>({
  notStarted: false,
  inProgress: false,
  completed: false
});


  const showToast = (msg: string) => {
    setToastMessage(msg);
    setToastOpen(true);
    setTimeout(() => setToastOpen(false), 3000);
  };
  
  const filteredCardData = useMemo(() => {
    const { notStarted, inProgress, completed } = checkedStates;
    if (!notStarted && !inProgress && !completed) return cardData;

    return cardData.filter((card) => {
      const hasInput = !!card.input_dt;
      const hasProd = !!card.prod_dt;

      if (notStarted && !hasInput && !hasProd) return true;
      if (inProgress && hasInput && !hasProd) return true;
      if (completed && hasInput && hasProd) return true;

      return false;
    });
  }, [cardData, checkedStates]);

  const columnCount = 2;

  const paginatedData = [...filteredCardData]
  .filter(x => x.seq != null)
  .sort((a, b) => {
    const rank = (item: CardItem) => {
      const hasInput = !!item.input_dt;
      const hasProd = !!item.prod_dt;

      if (hasInput && !hasProd) return 0;
      if (!hasInput && !hasProd) return 1;
      return 2;
    };
    const aRank = rank(a);
    const bRank = rank(b);
    if (aRank !== bRank) return aRank - bRank;
    return a.seq - b.seq;
  })
  .slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);




  // Ìï≠ÏÉÅ 8Í∞úÎ°ú Í≥†Ï†ï (Îπà Ïπ∏ Ìè¨Ìï®)
  const paddedData: (CardItem | null)[] = [...paginatedData];
  while (paddedData.length < itemsPerPage) {
    paddedData.push(null);  // Îπà ÏûêÎ¶¨Ïö©
  }


  const rowsByColumns = Array.from({ length: Math.ceil(paddedData.length / columnCount) }, (_, rowIndex) =>
    paddedData.slice(rowIndex * columnCount, rowIndex * columnCount + columnCount)
  );

  const totalPages = Math.ceil(filteredCardData.length / itemsPerPage); // ‚úÖ Ï≤¥ÌÅ¨Î∞ïÏä§ ÌïÑÌÑ∞ Í≤∞Í≥º Í∏∞Ï§Ä

  useEffect(() => {
    if (open && config === null) {
      // ÎîîÌÖåÏùº ÌåùÏóÖÏù¥ Ïó¥Î¶¥ Îïå Îî± 1Ìöå Î°úÎî©
      loadConfigClient().then((cfg: DbConfig | null) => {
        if (cfg) {
          console.log("üì• config Ï†ÑÏ≤¥ ÎÇ¥Ïö©:", cfg);
          setConfig(cfg);
        } else {
          console.warn("‚ö†Ô∏è config Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®");
        }
      });
    }
  }, [open]);

  useEffect(() => {
    const fetchIp = async () => {
      try {
        const res = await fetch("http://localhost:4000/api/get-ip");
        const data = await res.json();
        console.log("üåê ÏÇ¨Ïö©Ïûê ÎÇ¥Î∂Ä IP:", data.localIp);
        console.log("üåç ÏÇ¨Ïö©Ïûê Ïô∏Î∂Ä IP:", data.externalIp);
        setLocalIp(data.localIp);
        setExternalIp(data.externalIp);
      } catch (err) {
        console.error("‚ùå IP Ï°∞Ìöå Ïã§Ìå®", err);
      }
    };

    fetchIp();
  }, []);


  useEffect(() => {
    if (!open || !data) return;

    const loadData = async () => {
      try {
        const quantity = Number(data.QUANTITY || 0);
        const sfc = String(data.SFC || "").slice(0, 128);

        const fullCount = Math.floor(quantity / 12);
        const remainder = quantity % 12;

        // ‚úÖ Í∏∞Î≥∏ Ïπ¥Îìú ÏÉùÏÑ±
        const generatedCards: CardItem[] = [];

        for (let i = 0; i < fullCount; i++) {
          generatedCards.push({
            seq: i + 1,
            qty: 12,
            input_dt: "",
            prod_dt: "",
            confirm_YN: "N",
            flag: "ACTIVE",
            sfc,
            q_sfc: sfc,
            operation: "",
            resource: ""
          });
        }

        if (remainder > 0) {
          generatedCards.push({
            seq: fullCount + 1,
            qty: remainder,
            input_dt: "",
            prod_dt: "",
            confirm_YN: "N",
            flag: "ACTIVE",
            sfc,
            q_sfc: sfc,
            operation: "",
            resource: ""
          });
        }

        // ‚úÖ MSSQLÏóêÏÑú Ï†ÄÏû•Îêú Ïä§Ï∫î Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        const res = await axios.get("http://localhost:4000/api/mssql/escan-detail-v2", {
          params: {
            plant_cd: plant_cd,
            sfc_cd: sfc,
            work_center: data.WORK_CENTER,
          },
        });

        const savedScans = res.data as {
          SEQ: number;
          PCARD_QTY: number;
          INPUT_DT: string | null;
          PROD_DT: string | null;
        }[];


        // ‚úÖ Ïπ¥ÎìúÏóê ÎçÆÏñ¥Ïì∞Í∏∞
        for (const scan of savedScans) {
          const seqNum = Number(scan.SEQ);  // üî• ÌïµÏã¨ ÏàòÏ†ï
          const idx = generatedCards.findIndex(card => card.seq === seqNum);
          if (idx === -1) continue;

          const card = generatedCards[idx];
          card.input_dt = scan.INPUT_DT ?? "";
          card.prod_dt = scan.PROD_DT ?? "";
          card.qty = scan.PCARD_QTY ?? card.qty;

          const hasInput = !!card.input_dt;
          const hasProd = !!card.prod_dt;
          card.confirm_YN = hasInput && hasProd ? "P" : hasInput ? "T" : "N";

        }


        // ‚úÖ ÏÉÅÌÉú Ï†ÄÏû•
        setCardData(generatedCards);
        originalCardDataRef.current = JSON.parse(JSON.stringify(generatedCards));
        setIsSfcMode(false);
        setMinValidSfc(sfc);
        orderedSfcListRef.current = [sfc];

        console.log("‚úÖ ÏµúÏ¢Ö Ïπ¥Îìú Î¶¨Ïä§Ìä∏:", generatedCards);
      } catch (err) {
        console.error("‚ùå Ïπ¥Îìú ÏÉùÏÑ± Ïã§Ìå®:", err);
      }
    };

    loadData();
  }, [open, data?.ORDER_NUMBER]);




  // const savedMappingRef = useRef(false); // ‚úÖ Ï§ëÎ≥µ Ï†ÄÏû• Î∞©ÏßÄÏö©

  // useEffect(() => {
  //   if (!open || cardData.length === 0 || savedMappingRef.current) return;

  //   // ‚úÖ Îß§Ìïë Ï†ÄÏû•Ïö© payload Íµ¨ÏÑ±
  //   const payload = cardData.map((card) => ({
  //     ORDER_NUMBER: data.ORDER_NUMBER,
  //     SEQ: String(card.seq),
  //     SFC: card.mappedSFC
  //   }));
  // console.log("üì¶ Îß§Ìïë Ï†ÄÏû• ÏöîÏ≤≠:", payload);
  //   axios.post("http://localhost:4000/api/mssql/save-mapping", { list: payload })
  //     .then(() => {
  //       console.log("‚úÖ TMP_PCARD_SFC_MAPPING Ï†ÄÏû• ÏôÑÎ£å");
  //       savedMappingRef.current = true; // ‚úÖ Ïû¨Ìò∏Ï∂ú Î∞©ÏßÄ
  //     })
  //     .catch((err) => console.error("‚ùå Îß§Ìïë Ï†ÄÏû• Ïã§Ìå®:", err));
  // }, [open, cardData, data.ORDER_NUMBER]);


  const handleDetailOk = (clickedCard: CardItem) => {
    setCardData((prev) =>
      prev.map((item) => {
        if (item.seq !== clickedCard.seq) return item;

        const { input_dt, prod_dt } = item;
        let current = item.confirm_YN;
        let newStatus = current;

        if (current === "N") {
          newStatus = input_dt ? "TP" : "TT";
        } else if (current === "TT") {
          newStatus = input_dt ? "TP" : "T";
        } else if (current === "T") {
          newStatus = "TP";
        } else if (current === "TP") {
          if (input_dt && prod_dt) {
            newStatus = "P";
          } else {
            return item; // Ï°∞Í±¥ Î∂àÏ∂©Ï°± Ïãú ÏÉÅÌÉú Í∑∏ÎåÄÎ°ú Ïú†ÏßÄ
          }
        } else if (current === "Y" || current === "P") {
          return item; // ÌôïÏ†ïÎêòÍ±∞ÎÇò ÏôÑÎ£å ÏÉÅÌÉúÎäî Î¨¥Ïãú
        }

        console.log(`üü¢ ÌÅ¥Î¶≠ ÌóàÏö©Îê®: ${item.seq}, confirm_YN: ${current} ‚Üí ${newStatus}`);
        return { ...item, confirm_YN: newStatus };
      })
    );
  };




  const getColorByStatus = (status: string) => {
    switch (status) {
      case "Y":
      case "P": return "limegreen";
      case "T": return "dodgerblue";
      case "TP": return "orange";
      case "TT": return "yellow";
      case "N": return "#f5f5f5";
    }
  };

  const getImageByStatus = (status: string) => {
    switch (status) {
      case "P":
      case "Y": return okGreen;
      case "TP": return okOrange;
      case "T": return okDodgerblue;
      case "TT": return okYellow;
      case "N": return okWhite;
      default: return okWhite;
    }
  };

  const getModifiedRows = (original: CardItem[], current: CardItem[]) => {
    return current
      .map((cur, idx) => {
        const ori = original[idx];

        const normalizedCurStatus = cur.confirm_YN === "TP" ? "P"
                                    : cur.confirm_YN === "TT" ? "T"
                                    : cur.confirm_YN;

        const normalizedOriStatus = ori.confirm_YN === "TP" ? "T"
                                    : ori.confirm_YN === "TT" ? "N"
                                    : ori.confirm_YN;

        const isChanged = normalizedCurStatus !== normalizedOriStatus;

        // ‚úÖ SCAN_TYPE Í≤∞Ï†ï: input_dtÍ∞Ä ÏóÜÏúºÎ©¥ 'T', ÏûàÏúºÎ©¥ 'P'
        const scanType = cur.input_dt == null ? "T" : "P"; // ‚úÖ Îçî ÏïàÏ†ÑÌïú ÎπÑÍµê

        return {
          ...cur,
          confirm_YN: normalizedCurStatus,
          SCAN_TYPE: scanType,
          _changed: isChanged && ["T", "P"].includes(normalizedCurStatus)
        };
      })
      .filter(item => item._changed)
      .map(({ _changed, ...rest }) => rest); // _changed Ï†úÍ±∞ ÌõÑ Î∞òÌôò
  };


    // // ‚úÖ Í∑∏ Îã§ÏùåÏóê useMemo
    // const hasModifiedCards = useMemo(() => {
    //   const modified = getModifiedRows(originalCardDataRef.current, cardData);
    //   return modified.length > 0;
    // }, [cardData]);

    // const hasUpdatableCards = useMemo(() => {
    //   return cardData.some(card =>
    //     (card.confirm_YN === "N" || card.confirm_YN === "I") && card.flag !== "FINISH"
    //   );
    // }, [cardData]);

    // ‚úÖ ÌïÑÌÑ∞Îêú Ïπ¥Îìú Ï§ë ÏàòÏ†ïÎêú Í≤ÉÎßå Ï∂îÏ∂ú
    const filteredModifiedCards = useMemo(() => {
      const modified = getModifiedRows(originalCardDataRef.current, cardData);
      return modified.filter((card) =>
        filteredCardData.some(f => f.seq === card.seq)
      );
    }, [cardData, filteredCardData]);

    // ‚úÖ ÌïÑÌÑ∞Îêú Ïπ¥Îìú Ï§ë Ï†ÄÏû• Í∞ÄÎä•Ìïú Í≤É Ï∂îÏ∂ú (N, T ÏÉÅÌÉú)
    const filteredUpdatableCards = useMemo(() => {
      return filteredCardData.filter(card =>
        (card.confirm_YN === "N" || card.confirm_YN === "T") &&
        card.flag !== "FINISH"
      );
}, [filteredCardData]);

    // ‚úÖ ÌòÑÏû¨ ÏÑ†ÌÉùÎêú SFCÍ∞Ä Í∞ÄÏû• Îπ†Î•∏ SFCÏù∏ÏßÄ Ïó¨Î∂Ä ÌåêÎã®
    const isSingleSfc = orderedSfcListRef.current.length <= 1;
    const isClickable = isSingleSfc || (stableSfc !== "" && stableSfc === minValidSfc);

    // ‚úÖ ÌòÑÏû¨ SFCÍ∞Ä Ï†úÌïúÎêú ÏÉÅÌÉúÏù∏ÏßÄ (Ï†ÄÏû• Ï∞®Îã® Ï°∞Í±¥)
    const isSfcBlocked = isSfcMode && !!minValidSfc && data.SFC !== minValidSfc;

    // // ‚úÖ Ï†ÄÏû• Í∞ÄÎä• Ïó¨Î∂Ä (Í∏∞Ï°¥ Ï°∞Í±¥ + ÌÅ¥Î¶≠ Í∞ÄÎä• Ïó¨Î∂Ä Ìè¨Ìï®)
    // const canSaveDetail = hasModifiedCards && !isSfcBlocked && isClickable;
    // const canSaveAll = hasUpdatableCards && !isSfcBlocked && isClickable;
    // ‚úÖ Ï†ÄÏû• Í∞ÄÎä• Ïó¨Î∂Ä (Í∏∞Ï°¥ Ï°∞Í±¥ + ÌïÑÌÑ∞ Ï†ÅÏö©)
    const canSaveDetail = filteredModifiedCards.length > 0 && !isSfcBlocked && isClickable;
    const canSaveAll = filteredUpdatableCards.length > 0 && !isSfcBlocked && isClickable;

    const isCardClickable = (card: CardItem): boolean => {
      if (!isSfcMode) return true;

      if (!data?.SFC) return false;

      if (minValidSfc && data.SFC !== minValidSfc) return false;

      return card.mappedSFC === data.SFC;
    };




    const callSapStartApi = async (payload: {
      plant: string;
      operation: string;
      resource: string;
      // quantity: number;
      sfcs: string[];
      processLot: string;
    }) => {
      try {
        console.log("üöÄ [SAP START] Ìò∏Ï∂ú Ï§ÄÎπÑ ÏãúÏûë");

        if (!getAccessToken()) {
          console.warn("üîí ÌÜ†ÌÅ∞ ÏóÜÏùå ‚Üí ÌÜ†ÌÅ∞ ÏÉàÎ°ú Î∞úÍ∏â ÏãúÎèÑ Ï§ë...");
          await refreshToken();
        }

        const token = getAccessToken();
        if (!token) {
          console.error("‚ùå SAP ÌÜ†ÌÅ∞ Î∞úÍ∏â Ïã§Ìå® ‚Üí API Ìò∏Ï∂ú Ï§ëÎã®");
          return;
        }

        console.log("üì° [SAP START] Ïã§Ï†ú Ìò∏Ï∂ú ÏãúÏûë");
        console.log("üßæ Ìò∏Ï∂ú URL:", SAP_CONFIG.SFC_START_API);
        console.log("üì¶ ÏöîÏ≤≠ Payload:", JSON.stringify(payload, null, 2));
        console.log("üîë ÌÜ†ÌÅ∞ ÏùºÎ∂Ä:", token.slice(0, 10) + "...");

        const res = await axios.post("http://localhost:4000/api/sap-start", payload);

        console.log("‚úÖ SAP ÏùëÎãµ ÏàòÏã† ÏÑ±Í≥µ:", res.data);
      } catch (err: any) {
        const apiErr = err.response?.data?.error;
        console.error("‚ùå SAP Ìò∏Ï∂ú Ïò§Î•ò:", apiErr?.message || err.message);
        console.error("üì• Ïò§Î•ò ÏùëÎãµ Ï†ÑÏ≤¥:", err.response?.data || "(ÏùëÎãµ ÏóÜÏùå)");
      }
    };

    const callSapEndApi = async (payload: {
      plant: string;
      operation: string;
      resource: string;
      // quantity: number;
      sfcs: string[];
      processLot: string;
    }) => {
      try {
        console.log("üöÄ [SAP End] Ìò∏Ï∂ú Ï§ÄÎπÑ ÏãúÏûë");

        if (!getAccessToken()) {
          console.warn("üîí ÌÜ†ÌÅ∞ ÏóÜÏùå ‚Üí ÌÜ†ÌÅ∞ ÏÉàÎ°ú Î∞úÍ∏â ÏãúÎèÑ Ï§ë...");
          await refreshToken();
        }

        const token = getAccessToken();
        if (!token) {
          console.error("‚ùå SAP ÌÜ†ÌÅ∞ Î∞úÍ∏â Ïã§Ìå® ‚Üí API Ìò∏Ï∂ú Ï§ëÎã®");
          return;
        }

        const res = await axios.post("http://localhost:4000/api/sap-complete", payload);

        console.log("‚úÖ SAP ÏùëÎãµ ÏàòÏã† ÏÑ±Í≥µ:", res.data);
      } catch (err: any) {
        const apiErr = err.response?.data?.error;
        console.error("‚ùå SAP Ìò∏Ï∂ú Ïò§Î•ò:", apiErr?.message || err.message);
        console.error("üì• Ïò§Î•ò ÏùëÎãµ Ï†ÑÏ≤¥:", err.response?.data || "(ÏùëÎãµ ÏóÜÏùå)");
      }
    };


  //v1
  const handlePostConfirm = async (cardsToSave: any[]) => {
    try {
      await axios.post("http://localhost:4000/api/mssql/escan-detail-save", { list: cardsToSave });
      setCardData(prev =>
        prev.map(item =>
          cardsToSave.some(c => c.SEQ === item.seq.toString())
            ? { ...item, confirm_YN: "Y" }
            : item
        )
      );
    } catch (err) {
      showToast("‚ùå Ï†ÄÏû• Ïã§Ìå®");
    }
  };

  const handlePostConfirm_V2 = async (cardsToSave: SavePayloadItem[]) => {
  try {
    await axios.post("http://localhost:4000/api/mssql/escan-detail-save_v2", {
      list: cardsToSave,
    });

    // ‚úÖ Ï†ÄÏû• ÏÑ±Í≥µ Ïãú ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    setCardData(prev =>
      prev.map(item =>
        cardsToSave.some(c => c.SEQ === item.seq.toString())
          ? { ...item, confirm_YN: "Y" }
          : item
      )
    );
  } catch (err) {
    console.error("‚ùå Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù:", err);
    showToast("‚ùå Ï†ÄÏû• Ïã§Ìå®");
  }
};

  const fetchSfcDetail = async (plant_cd: string, sfc: string) => {
    try {
      const res = await axios.get("http://localhost:4000/api/sap/sfc-detail", {
        params: { plant_cd, sfc },
      });
      return res.data;
    } catch (err: any) {
      console.error("‚ùå SAP SFC ÏÉÅÌÉú Ï°∞Ìöå Ïã§Ìå®:", err.response?.data || err.message);
      return null;
    }
  };

//   const fetchGoodsReceipts = async (
//   plant: string,
//   order?: string,
//   sfc?: string,
//   material?: string
// ) => {
//   try {
//     const res = await axios.get("http://localhost:4000/api/sap/goodsreceipts", {
//       params: {
//         plant,
//         ...(order && { order }),
//         ...(sfc && { sfc }),
//         ...(material && { material })
//       }
//     });

//     return res.data;
//   } catch (err: any) {
//     console.error("‚ùå SAP ÏûÖÍ≥† Ïù¥Î†• Ï°∞Ìöå Ïã§Ìå®:", err.response?.data || err.message);
//     return null;
//   }
// };
  const fetchPostedGoodsReceipts = async (
    plant: string,
    order: string,
    sfc: string,
    material: string,
    transactionIds: string[], // ‚Üê TxID Ïú†Î¨¥Ïóê Îî∞Îùº ÌïÑÌÑ∞ÎßÅ Ïó¨Î∂Ä Í≤∞Ï†ï
    maxRetries = 50,
    delayMs = 1000
  ): Promise<any[]> => {
    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        const res = await axios.get("http://localhost:4000/api/sap/goodsreceipts", {
          params: { plant, order, sfc, material }
        });

        const data = Array.isArray((res.data as any))
          ? (res.data as any)
          : Array.isArray((res.data as any)?.content)
          ? (res.data as any).content
          : Array.isArray((res.data as any)?.lineItems)
          ? (res.data as any).lineItems
          : [];


        // üîç POSTED Îêú Ï†ÑÏ≤¥
        const postedOnly = data.filter((d: any) => d.status === "POSTED_TO_TARGET_SYS");

        // üîç TxIDÍ∞Ä Ï†úÍ≥µÎêú Í≤ΩÏö∞ ‚Üí Îß§Ïπ≠ÎêòÎäî Í≤å ÏûàÏùÑ ÎïåÎßå Î¶¨ÌÑ¥
        if (transactionIds.length > 0) {
          const matched = postedOnly.filter((d: any) =>
            transactionIds.includes(d.transactionId?.trim?.())
          );

          if (matched.length > 0) {
            console.log(`‚úÖ TxID Îß§Ïπ≠Îêú ÏûÖÍ≥† Îç∞Ïù¥ÌÑ∞ Î∞úÍ≤¨ (ÏãúÎèÑ ${attempt}Ìöå)`);
            console.table(
              matched.map((d: any) => ({
                order: d.order,
                sfc: d.sfc,
                txId: d.transactionId,
                qty: d.quantityInBaseUnit?.value,
              }))
            );
            return postedOnly; // Ï†ÑÏ≤¥ POSTED Î∞òÌôò (TxID ÌïÑÌÑ∞Îäî Î∞îÍπ•ÏóêÏÑú ÏÇ¨Ïö©)
          }

          console.log(`‚è≥ TxID Îß§Ïπ≠ Í≤∞Í≥º ÏóÜÏùå (ÏãúÎèÑ ${attempt}Ìöå) ‚Üí Ïû¨ÏãúÎèÑ`);
          await new Promise((res) => setTimeout(res, delayMs));
        } else {
          // TxIDÍ∞Ä ÏóÜÏúºÎ©¥ Î∞îÎ°ú Î¶¨ÌÑ¥ (Ï†ÑÏ≤¥ Ï°∞ÌöåÏö©)
          console.log(`‚úÖ Ï†ÑÏ≤¥ POSTED ÏûÖÍ≥† Ï°∞Ìöå (TxID ÏóÜÏùå, ${postedOnly.length}Í±¥)`);
          return postedOnly;
        }
      } catch (err) {
        console.warn(`üö® Ï°∞Ìöå Ïã§Ìå® (ÏãúÎèÑ ${attempt}Ìöå):`, err);
        await new Promise((res) => setTimeout(res, delayMs));
      }
    }

    console.warn("‚ùå ÏµúÎåÄ Ïû¨ÏãúÎèÑ Ï¥àÍ≥º. TxID ÏùºÏπò ÏûÖÍ≥† Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏ Î∂àÍ∞Ä");
    return [];
  };














  const callSapPostAssembledComponent = async ({
      plant,
      sfc,
      operationActivity,
      component,
      componentVersion,
      quantity,
      resource,
      sequence
    }: {
      plant: string;
      sfc: string;
      operationActivity: string;
      component: string;
      componentVersion: string;
      quantity: number;
      resource: string;
      sequence: number;
    }) => {
      console.log("üöÄ [SAP Assemble] Ìò∏Ï∂ú ÏãúÏûë");
      console.log("üì¶ ÏöîÏ≤≠ Payload:", {
        plant,
        sfc,
        operationActivity,
        component,
        componentVersion,
        quantity,
        resource,
        sequence
      });

      try {
        // ÌÜ†ÌÅ∞ Ï≤¥ÌÅ¨ Î∞è Í∞±Ïã†
        if (!getAccessToken()) {
          console.warn("üîê Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ ÏóÜÏùå ‚Üí ÌÜ†ÌÅ∞ Í∞±Ïã† ÏãúÎèÑ Ï§ë...");
          await refreshToken();
        }

        const token = getAccessToken();
        if (!token) {
          console.error("‚ùå Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ ÌöçÎìù Ïã§Ìå® ‚Üí API Ìò∏Ï∂ú Ï§ëÎã®");
          return;
        }

        // Ïã§Ï†ú API ÏöîÏ≤≠
        const payload = {
          plant,
          sfc,
          operationActivity,
          component,
          componentVersion,
          quantity,
          resource
        };

        const url = "http://localhost:4000/api/sap-post-assembled";
        console.log("üåê Ìò∏Ï∂ú URL:", url);

        const res = await axios.post(url, payload, {
          headers: {
            Authorization: `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        });

        console.log("‚úÖ SAP assembledComponents Ìò∏Ï∂ú ÏÑ±Í≥µ:", res.data);
      } catch (err: any) {
        const responseData = err?.response?.data || {};
        console.error("‚ùå SAP assembledComponents Ìò∏Ï∂ú Ïã§Ìå®:", responseData.error || err.message);
        console.error("üì• Ï†ÑÏ≤¥ Ïò§Î•ò ÏùëÎãµ:", responseData);
      }
    };

    //
    const callSapPostAssembledComponent_auto = async ({
    plant,
    sfc,
    operationActivity,
    quantity,
    resource,
    hasTimeBased = true,       // ‚úÖ Í∏∞Î≥∏Í∞í true
    hasNonTimeBased = true     // ‚úÖ Í∏∞Î≥∏Í∞í true
  }: {
    plant: string;
    sfc: string;
    operationActivity: string;
    quantity: number;
    resource: string;
    hasTimeBased?: boolean;     // ‚úÖ ÏÑ†ÌÉùÏ†Å Îß§Í∞úÎ≥ÄÏàòÎ°ú Ï∂îÍ∞Ä
    hasNonTimeBased?: boolean;
  }) => {
    console.log("üöÄ [SAP Assemble] Ìò∏Ï∂ú ÏãúÏûë");
    const payload = {
      plant,
      operationActivity,
      quantity,
      resource,
      sfcs: [sfc],              // ‚úÖ Î∞∞Ïó¥Î°ú Ï†ÑÎã¨
      hasTimeBased,
      hasNonTimeBased
    };

    try {
      if (!getAccessToken()) {
        console.warn("üîê Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ ÏóÜÏùå ‚Üí ÌÜ†ÌÅ∞ Í∞±Ïã† ÏãúÎèÑ Ï§ë...");
        await refreshToken();
      }

      const token = getAccessToken();
      if (!token) {
        console.error("‚ùå Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ ÌöçÎìù Ïã§Ìå® ‚Üí API Ìò∏Ï∂ú Ï§ëÎã®");
        return;
      }

      const url = "http://localhost:4000/api/sap-post-assembled_auto";
      console.log("üåê Ìò∏Ï∂ú URL:", url);
      console.log("üì¶ ÏöîÏ≤≠ Payload:", payload);

      const res = await axios.post(url, payload, {
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        }
      });

      console.log("‚úÖ SAP assembledComponents Ìò∏Ï∂ú ÏÑ±Í≥µ:", res.data);
    } catch (err: any) {
      const responseData = err?.response?.data || {};
      console.error("‚ùå SAP assembledComponents Ìò∏Ï∂ú Ïã§Ìå®:", responseData.error || err.message);
      console.error("üì• Ï†ÑÏ≤¥ Ïò§Î•ò ÏùëÎãµ:", responseData);
    }
  };

  //// ‚úÖ SAP POST Ìà¨ÏûÖ (Goods Issue) Ìò∏Ï∂ú
  const callSapPostGoodsIssue = async ({
    plant,
    order,
    phase,
    workCenter,
    component,
    componentVersion,
    quantity,
    unitOfMeasure,
    postedBy,
    postingDateTime,
    bomCode,
    bomVersion,
    inventoryId
  }: {
    plant: string;
    order: string;
    phase: string;
    workCenter: string;
    component: string;
    componentVersion: string;
    quantity: number;
    unitOfMeasure: string;
    postedBy: string;
    postingDateTime: string;
    bomCode: string;
    bomVersion: string;
    inventoryId: string;
  }) => {
    try {
      const res = await axios.post("http://localhost:4000/api/sap-post-goodsissue", {
        plant,
        order,
        phase,
        workCenter,
        inventoryId, // ‚úÖ Ï∂îÍ∞ÄÎê®
        component: {
          material: {
            material: component,
            version: componentVersion
          }
        },
        bom: {
          bom: bomCode,
          version: bomVersion
        },
        isBomComponent: true,
        quantity,
        unitOfMeasure,
        postedBy,
        postingDateTime
      });

      console.log("‚úÖ goodsissue ÏÑ±Í≥µ", res.data);
    } catch (err: any) {
      console.error("‚ùå goodsissue Ïã§Ìå®", err.response?.data || err.message);
    }
  };


  const callSapPostGoodsReceipt = async ({
    plant,
    order,
    postedBy,
    lineItems
  }: {
    plant: string;
    order: string;
    postedBy?: string;
    lineItems: {
      material: string;
      materialVersion?: string;
      postingDate: string;
      postingDateTime?: string;
      quantity: {
        unitOfMeasure: {
          commercialUnitOfMeasure: string;
          internalUnitOfMeasure: string;
          isoUnitOfMeasure: string;
        };
        value: number;
      };
      sfc: string;
      storageLocation: string;
    }[];
  }): Promise<any> => {
    console.log("üöÄ [SAP GoodsReceipt] Ìò∏Ï∂ú ÏãúÏûë");
    console.log("üì¶ ÏöîÏ≤≠ Payload:", {
      plant,
      order,
      postedBy,
      lineItems
    });

    try {
      if (!getAccessToken()) {
        console.warn("üîê Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ ÏóÜÏùå ‚Üí ÌÜ†ÌÅ∞ Í∞±Ïã† ÏãúÎèÑ Ï§ë...");
        await refreshToken();
      }

      const token = getAccessToken();
      if (!token) {
        console.error("‚ùå Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ ÌöçÎìù Ïã§Ìå® ‚Üí API Ìò∏Ï∂ú Ï§ëÎã®");
        return;
      }

      const payload = {
        plant,
        order,
        postedBy: postedBy || "system",
        lineItems
      };

      const url = "http://localhost:4000/api/sap-goods-receipt";
      console.log("üåê Ìò∏Ï∂ú URL:", url);

      const res = await axios.post(url, payload, {
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        }
      });

      console.log("‚úÖ SAP GoodsReceipt Ìò∏Ï∂ú ÏÑ±Í≥µ:", res.data);
      return res.data; // ‚úÖ Í≤∞Í≥º Î∞òÌôò Ï∂îÍ∞Ä
    } catch (err: any) {
      const responseData = err?.response?.data || {};
      console.error("‚ùå SAP GoodsReceipt Ìò∏Ï∂ú Ïã§Ìå®:", responseData.error || err.message);
      console.error("üì• Ï†ÑÏ≤¥ Ïò§Î•ò ÏùëÎãµ:", responseData);
      throw err; // ‚ùó Ïò§Î•òÎäî ÏÉÅÏúÑÏóêÏÑú Ï≤òÎ¶¨Ìï† Ïàò ÏûàÎèÑÎ°ù throw Ìï¥Ï£ºÎäî Í≤å Ï¢ãÏùå
    }
  };


  
/// Í∏∞Ï°¥ ÏûÖÍ≥† Î∞©Ïãù ÏûòÎê®!!!
  // const callSapPostGoodsReceipt = async ({
  //   plant,
  //   order,
  //   postedBy,
  //   lineItems
  // }: {
  //   plant: string;
  //   order: string;
  //   postedBy?: string;
  //   lineItems: {
  //     material: string;
  //     materialVersion?: string;
  //     postingDate: string;
  //     postingDateTime?: string;
  //     quantity: {
  //       unitOfMeasure: {
  //         commercialUnitOfMeasure: string;
  //         internalUnitOfMeasure: string;
  //         isoUnitOfMeasure: string;
  //       };
  //       value: number;
  //     };
  //     sfc: string;
  //     storageLocation: string;
  //   }[];
  // }) => {
  //   console.log("üöÄ [SAP GoodsReceipt] Ìò∏Ï∂ú ÏãúÏûë");
  //   console.log("üì¶ ÏöîÏ≤≠ Payload:", {
  //     plant,
  //     order,
  //     postedBy,
  //     lineItems
  //   });

  //   try {
  //     if (!getAccessToken()) {
  //       console.warn("üîê Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ ÏóÜÏùå ‚Üí ÌÜ†ÌÅ∞ Í∞±Ïã† ÏãúÎèÑ Ï§ë...");
  //       await refreshToken();
  //     }

  //     const token = getAccessToken();
  //     if (!token) {
  //       console.error("‚ùå Ïï°ÏÑ∏Ïä§ ÌÜ†ÌÅ∞ ÌöçÎìù Ïã§Ìå® ‚Üí API Ìò∏Ï∂ú Ï§ëÎã®");
  //       return;
  //     }

  //     const payload = {
  //       plant,
  //       order,
  //       postedBy: postedBy || "system",
  //       lineItems
  //     };

  //     const url = "http://localhost:4000/api/sap-goods-receipt";
  //     console.log("üåê Ìò∏Ï∂ú URL:", url);

  //     const res = await axios.post(url, payload, {
  //       headers: {
  //         Authorization: `Bearer ${token}`,
  //         "Content-Type": "application/json"
  //       }
  //     });

  //     console.log("‚úÖ SAP GoodsReceipt Ìò∏Ï∂ú ÏÑ±Í≥µ:", res.data);
  //   } catch (err: any) {
  //     const responseData = err?.response?.data || {};
  //     console.error("‚ùå SAP GoodsReceipt Ìò∏Ï∂ú Ïã§Ìå®:", responseData.error || err.message);
  //     console.error("üì• Ï†ÑÏ≤¥ Ïò§Î•ò ÏùëÎãµ:", responseData);
  //   }
  // };


  //// ‚úÖ SAP POST ÏûêÎèô Activity Confirmation Ìò∏Ï∂ú
  const callSapPostAutoConfirm = async ({
    plant,
    shopOrder,
    sfc,
    operationActivity,
    operationActivityVersion,
    stepId,
    workCenter,
    resource,
    routingId,
    finalConfirmation,
    postConfirmationToErp,
    postedBy,
    postingDateTime
  }: {
    plant: string;
    shopOrder: string;
    sfc: string;
    operationActivity: string;
    operationActivityVersion: string;
    stepId: string;
    workCenter: string;
    resource: string;
    routingId: string;
    finalConfirmation: boolean;
    postConfirmationToErp: boolean;
    postedBy: string;
    postingDateTime: string;
  }) => {
    try {
      const res = await axios.post("http://localhost:4000/api/sap-post-autoconfirm", {
        plant,
        shopOrder,
        sfc,
        operationActivity,
        operationActivityVersion,
        stepId,
        workCenter,
        resource,
        routingId,
        finalConfirmation,
        postConfirmationToErp,
        postedBy,
        postingDateTime
      });

      console.log("‚úÖ AutoActivityConfirm ÏÑ±Í≥µ", res.data);
    } catch (err: any) {
      console.error("‚ùå AutoActivityConfirm Ïã§Ìå®", err.response?.data || err.message);
    }
  };





  ////////////////////////////////////////////////////////////////Save_Detail///////////////////////////////////////////////////////////////////////
  const handleSaveDetail = async () => {
    const changed = getModifiedRows(originalCardDataRef.current, cardData);
    const filtered = changed.filter(item => ["T", "P"].includes(item.confirm_YN));

    if (filtered.length === 0) return showToast("Î≥ÄÍ≤ΩÎêú Ïπ¥ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§.");
    const rawSfc = String(data?.SFC || "").slice(0, 128);

    if (!rawSfc) {
      console.error("‚ùå Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ SFC: null ÎòêÎäî Îπà Î¨∏ÏûêÏó¥ÏûÖÎãàÎã§.");
      showToast("SFC Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
      return;
    }

    const payload = filtered.map(item => ({
      PLANT_CD: plant_cd,
      WORK_CENTER: data.WORK_CENTER,
      ORDER_NUMBER: data.ORDER_NUMBER,
      SEQ: item.seq.toString(),
      MATERIAL_CODE: data.MATERIAL_CODE,
      SIZE_CD: data.SIZE_CD,
      ITPO_TYPE: item.confirm_YN,
      SFC: rawSfc,
      SCAN_TYPE: !item.input_dt ? "T" : "P",
      PCARD_QTY: item.qty,
      USER_IP: localIp || "0.0.0.0",
      DEVICE_ID: "POP_DEVICE_01"
    }));

    handlePostConfirm_V2(payload);

    onConfirm?.(payload);

    //Sap Api Ìò∏Ï∂úÏùÑ ÏúÑÌïú ÌïÑÏàò Ï†ïÎ≥¥
     // üîç SAP SFC Detail Ï°∞Ìöå ‚Üí operation Í∞í ÎèôÏ†Å Ï∂îÏ∂ú
    const sfcDetail = await fetchSfcDetail(plant_cd, String(data.SFC).slice(0, 128)) as any;
    
    // üîÅ BOM Ï†ïÎ≥¥ Ï∂îÏ∂ú
    const bomCode = sfcDetail?.bom?.bom;
    const rawBomType = sfcDetail?.bom?.type;
    // üîÅ BOM type Î≥ÄÌôò (SAP ‚Üí API expected)
    const bomType = rawBomType === "SHOPORDERBOM"
      ? "SHOP_ORDER"
      : rawBomType === "MASTERBOM"
      ? "MASTER"
      : rawBomType === "SFCBOM"
      ? "SFC"
      : undefined;

    if (!bomCode || !bomType) {
      console.warn("‚ùó BOM Ï†ïÎ≥¥Í∞Ä ÏóÜÍ±∞ÎÇò ÌÉÄÏûÖ Î≥ÄÌôò Ïã§Ìå®");
      return showToast("BOM Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
    }

    
    const operation = sfcDetail?.steps?.[0]?.operation?.operation;
    const step = sfcDetail?.steps?.[0];
    const stepId = step?.stepId;                  //Activity ComfirmationÏÇ¨Ïö©
    const routing = step?.stepRouting?.routing;   //Activity ComfirmationÏÇ¨Ïö©
    const resource = step?.resource; 
    const operation_Version = step?.operation?.version;
    const totalQuantity = Number(sfcDetail.quantity ?? 0);
    if (!operation) {
      console.error("‚ùå operation Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
      throw new Error("SFCÏùò operation Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
    }

    // 2. üì¶ SAP BOM API Ìò∏Ï∂ú Î∞è Íµ¨ÏÑ±Ìíà Ï∂îÏ∂ú
    let components: {
        component: string;
        componentVersion: string;
        quantity: number;
        totalQuantity?: number | null; // üîß Ïù¥ Ï§ÑÏùÑ Ï∂îÍ∞Ä
        unitOfMeasure: string;
        storageLocation: string;
      }[] = [];
    let baseUnitOfMeasure = "";
    let bomVersion = "";
    let resolvedBomCode = "";  

    try {
      const bomResp = await axios.get("http://localhost:4000/api/sap/bom-detail", {
        params: {
          plant: plant_cd,
          bom: bomCode,
          type: bomType
        }
      });

      const bomData = Array.isArray(bomResp.data) ? bomResp.data[0] : bomResp.data;
      console.log("üì¶ [RAW_BOM_DATA]", JSON.stringify(bomData, null, 2));

      baseUnitOfMeasure = bomData?.baseUnitOfMeasure;
      resolvedBomCode = bomData?.bom ?? "";
      bomVersion = bomData?.version ?? "";

      if (!Array.isArray(bomData?.components)) {
        console.warn("‚ùó BOM components Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
        return showToast("SAP BOM Íµ¨ÏÑ±Ìíà Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
      }

      components = (bomData.components as BomComponent[])
      .map((comp) => {
        const component = comp.material?.material ?? "";
        const componentVersion = comp.material?.version ?? "";
        const quantity = comp.quantity;
        const totalQuantity = comp.totalQuantity ?? null;
        const unitOfMeasure = comp.unitOfMeasure ?? ""; 
        const storageLocation = comp.storageLocation ?? ""; 

        if (!component || !componentVersion || quantity == null) return null;

        return {
          component,
          componentVersion,
          quantity,
          totalQuantity,
          unitOfMeasure,
          storageLocation
        };
      })
      .filter((c): c is {
        component: string;
        componentVersion: string;
        quantity: number;
        totalQuantity: number | null;
        unitOfMeasure: string;
        storageLocation: string;
      } => c !== null);

      console.log("üß© BOMÏóêÏÑú Ï∂îÏ∂úÎêú components:", components);
    } catch (err) {
      console.error("‚ùå BOM Detail Ï°∞Ìöå Ïã§Ìå®", err);
      return showToast("BOM ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎî© Ïã§Ìå®");
    }

     // ‚úÖ SAP START Ìò∏Ï∂ú Ï°∞Í±¥: Î™®Îì† Ïπ¥ÎìúÏóê input_dt ÏóÜÏùÑ ÎïåÎßå
    const hasAnyInput = cardData.some(c => !!c.input_dt);
    if (!hasAnyInput) {
      const sapPayload = {
        plant: plant_cd.slice(0, 6),
        operation,
        resource: String(data.WORK_CENTER ?? "").slice(0, 36),
        // quantity: Number(data.QUANTITY ?? 0),
        // quantity: 0,
        sfcs: [String(data.SFC ?? "").slice(0, 128)],
        processLot: ""
      };
      await callSapStartApi(sapPayload);
    }

    //  // ‚úÖ Input ÏÉÅÌÉúÏù∏ Ïπ¥ÎìúÎßå SAP ASSEMBLE Ìò∏Ï∂ú
    // for (const item of filtered) {
    //   if (item.confirm_YN === "T") {
    //     await callSapPostAssembledComponent_auto({
    //       plant: plant_cd,
    //       sfc: String(data.SFC).slice(0, 128),
    //       operationActivity: operation,
    //       quantity: item.qty,
    //       resource: String(data.WORK_CENTER).slice(0, 36),
    //       hasTimeBased: true,
    //       hasNonTimeBased: true
    //     });
    //   }
    // }
    // ‚úÖ SAP Goods Issue Ï≤òÎ¶¨ (1Í±¥Ïî© Ï≤òÎ¶¨ + issued Ïû¨Ï°∞Ìöå Î∞©Ïãù)
    const issuedMap = new Map<string, number>();
    const processingMap = new Map<string, number>();
    const remainingQtyMap = new Map<string, number>();
    const requiredTotalMap = new Map<string, number>();
    const PRECISION = 1000;

    // ‚úÖ Íµ¨ÏÑ±ÌíàÎ≥Ñ Ï¥ù ÌïÑÏöî ÏàòÎüâ Í≥ÑÏÇ∞
    const totalQty = data.qty;
    for (const comp of components) {
      const key = `${comp.component}|${comp.componentVersion}`;
      const total = Number((comp.totalQuantity ?? comp.quantity * totalQty).toFixed(3));
      requiredTotalMap.set(key, total);
    }

    // ‚úÖ issuedMap: Íµ¨ÏÑ±ÌíàÎ≥ÑÎ°ú 1ÌöåÎßå Ï°∞Ìöå
    for (const comp of components) {
      const key = `${comp.component}|${comp.componentVersion}`;
      try {
        const issuedResp = await axios.get("http://localhost:4000/api/sap/goodsissued-components", {
          params: {
            plant: plant_cd,
            material: comp.component,
            materialVersion: comp.componentVersion,
            order: data.ORDER_NUMBER,
            sfc: rawSfc,
            workCenter: String(data.WORK_CENTER ?? "").trim()
          }
        });

        const issuedData = Array.isArray(issuedResp.data)
          ? issuedResp.data
          : (issuedResp.data as any)?.content ?? [];


          

        let totalIssued = 0; // ÌÖåÏä§Ìä∏ Ï¥àÍ∏∞Í∞í
        for (const entry of issuedData) {
          const quantity = Number(entry.quantityInBaseUnit?.value ?? 0);
          if (
            entry.postingStatus === "POSTED_TO_TARGET_SYS" &&
            !entry.cancellationTriggered &&
            quantity > 0
          ) {
            totalIssued += quantity;
          }
        }

        const issuedSoFar = Math.round(totalIssued * PRECISION) / PRECISION;
        issuedMap.set(key, issuedSoFar);
        console.log(`‚úÖ [Ï¥àÍ∏∞ issued Ï°∞Ìöå ÏôÑÎ£å] ${key} = ${issuedSoFar}`);
      } catch (err) {
        console.warn(`‚ùó issued Ï°∞Ìöå Ïã§Ìå® (${key})`, err);
        issuedMap.set(key, 1); // ÌÖåÏä§Ìä∏Ïö© ÎîîÌè¥Ìä∏
      }
    }
    let index = 0;
    // ‚úÖ Ïπ¥ÎìúÎ≥Ñ Ìà¨ÏûÖ Ï≤òÎ¶¨
    for (const item of filtered) {
      if (item.confirm_YN !== "T") continue;

      for (const comp of components) {
        const key = `${comp.component}|${comp.componentVersion}`;
        const currentQty = Math.round(comp.quantity * item.qty * PRECISION) / PRECISION;
        let remainingQty = currentQty;
        let totalUsedThisCard = 0;

        // ÎàÑÏ†ÅÎêú Í∞í Î∂àÎü¨Ïò§Í∏∞
        const issuedSoFar = issuedMap.get(key) ?? 0;
        const prevProcessing = processingMap.get(key) ?? 0;
        const processingSoFar = Math.round(prevProcessing * PRECISION) / PRECISION;
        const requiredTotal = Math.round((requiredTotalMap.get(key) ?? 0) * PRECISION) / PRECISION;

        const inventoryResp = await axios.get("http://localhost:4000/api/sap/inventories", {
          params: {
            plant: plant_cd,
            material: comp.component,
            materialVersion: comp.componentVersion,
            stockRetrieveScope: "NO_ZERO_STOCK",
            batchesWithStatus: true,
            status: ["UNRESTRICTED", "RESTRICTED"],
            storageLocation: comp.storageLocation
          }
        });

        const sortedInventory = (inventoryResp.data as any[] ?? []).sort(
          (a: any, b: any) =>
            new Date(a.createdDateTime).getTime() - new Date(b.createdDateTime).getTime()
        );



        for (const inv of sortedInventory) {
          const availableQty = Math.round(Number(inv.quantityOnHand?.value ?? 0) * PRECISION) / PRECISION;
          if (availableQty <= 0 || remainingQty <= 0) continue;

          const maxConsumableQty = Math.max(0, requiredTotal - issuedSoFar - processingSoFar - totalUsedThisCard);
          const usedQty = Math.min(remainingQty, availableQty, maxConsumableQty);
          const usedQtyRounded = Math.round(usedQty * PRECISION) / PRECISION;
          if (usedQtyRounded <= 0) continue;

          console.log(
            `üßæ Ïπ¥Îìú[${item.seq}] | Íµ¨ÏÑ±Ìíà: ${comp.component}` +
            `\n   Ï¥ùÌïÑÏöî: ${requiredTotal}` +
            `\n   issuedSoFar: ${issuedSoFar}` +
            `\n   processingSoFar: ${processingSoFar}` +
            `\n   maxConsumableQty: ${maxConsumableQty}` +
            `\n   available: ${availableQty}` +
            `\n   remainingQty: ${remainingQty}` +
            `\n   ÏµúÏ¢Ö Ìà¨ÏûÖ: ${usedQtyRounded}`
          );

          try {
            await callSapPostGoodsIssue({
              plant: plant_cd,
              order: data.ORDER_NUMBER,
              phase: operation,
              workCenter: String(data.WORK_CENTER ?? "").slice(0, 36),
              component: comp.component,
              componentVersion: comp.componentVersion,
              quantity: usedQtyRounded,
              unitOfMeasure: comp.unitOfMeasure,
              postedBy: localIp,
              // postingDateTime: dayjs().subtract(10, "second").format("YYYY-MM-DD HH:mm:ss"),
              postingDateTime: new Date(Date.now() - (10000 - index * 1000)).toISOString(),
              bomCode: resolvedBomCode,
              bomVersion: bomVersion,
              inventoryId: inv.inventoryId
            });
          } catch (err) {
            console.warn(`‚ùå SAP GoodsIssue Ïã§Ìå®: ${inv.inventoryId} ${usedQtyRounded}`, err);
            continue;
          }
          index++;

          remainingQty = Math.round((remainingQty - usedQtyRounded) * PRECISION) / PRECISION;
          totalUsedThisCard = Math.round((totalUsedThisCard + usedQtyRounded) * PRECISION) / PRECISION;
        }

        // ‚úÖ Ïπ¥Îìú Ï≤òÎ¶¨ ÌõÑ Ï†ÑÏ≤¥ Ï≤òÎ¶¨Îüâ ÎàÑÏ†Å
        const newProcessing = Math.round((prevProcessing + totalUsedThisCard) * PRECISION) / PRECISION;
        processingMap.set(key, newProcessing);

        const remainingTotal = Math.round((requiredTotal - issuedSoFar - newProcessing) * PRECISION) / PRECISION;
        remainingQtyMap.set(key, remainingTotal);
      }
    }



    // // ‚úÖ ÏÑ†ÌÉùÌïú Ïπ¥ÎìúÍ∞Ä PÏùºÎïå complete SAP POST Ìò∏Ï∂ú
    // for (const item of filtered) {
    // if (item.confirm_YN === "P") {
    //   console.log("‚úÖ Receipts ÏßÑÏûÖ");
    //   const sapPayload = {
    //     plant: plant_cd.slice(0, 6),
    //     operation,
    //     resource: String(data.WORK_CENTER ?? "").slice(0, 36),
    //     quantity: item.qty,
    //     sfcs: [String(data.SFC ?? "").slice(0, 128)],
    //     processLot: ""
    //   };
    //   await callSapEndApi(sapPayload);
    //   }
    // }

    let index2 = 0;
    for (const item of filtered) {
      console.log("üß™ confirm_YN Í∞í:", item.confirm_YN);
      if (item.confirm_YN === "P") {
        console.log("‚úÖ GoodsReceipt ÏßÑÏûÖ");

        // ‚úÖ ÌïÑÏàò: SFC Î≤àÌò∏ (SAP ÏûÖÍ≥†Ïóê ÌïÑÏöî)
        const rawSfc = String(data.SFC ?? "").slice(0, 128);

        // ‚úÖ ÌïÑÏàò: ÏûÖÍ≥†ÏùºÏûê (YYYY-MM-DD ÌòïÏãù)
        const workDate = work_date;


        // ‚úÖ ÌïÑÏàò: Ï†ÄÏû•ÏúÑÏπò (SAP Ï†ÄÏû•ÏúÑÏπò ÏΩîÎìú)
        const storageLocation = String(data.PUTAWAYSTORAGELOCATION ?? "").slice(0, 10);

        // ‚úÖ ÌïÑÏàò: ÏÉùÏÇ∞Ïò§Îçî Î≤àÌò∏ (SAP ÏûÖÍ≥† Ï≤òÎ¶¨Ïóê ÌïÑÏöî)
        const orderNumber = String(data.ORDER_NUMBER ?? "").slice(0, 12);

        // ‚úÖ ÌïÑÏàò: ÏûêÏû¨ÏΩîÎìú (ÏûÖÍ≥† ÎåÄÏÉÅ ÏûêÏû¨)
        const materialCode = data.MATERIAL_CODE;

        // ‚úÖ ÏÑ†ÌÉù (ÌïÑÏöî Ïãú): ÏûêÏû¨ Î≤ÑÏ†Ñ
        const materialVersion = data.MATERIAL_VERSION || "ERP001";  // Í∏∞Î≥∏Í∞í Ï†ÅÏö©

        // ‚úÖ ÌïÑÏàò: Ïπ¥Îìú Îã®ÏúÑ ÏàòÎüâ
        const quantityValue = item.qty;

        

      // ‚úÖ 1. SAP Îã®ÏúÑÏΩîÎìú Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
      let uomData: any = null;
      try {
        const uomResp = await axios.get("http://localhost:4000/api/sap/unit-codes", {
          params: { unitCode: baseUnitOfMeasure }
        });

        // üîç ÏßÅÏ†ë ÏùºÏπò Í≤∞Í≥º ÏÇ¨Ïö© (SAP APIÍ∞Ä 1Í∞úÎßå Î¶¨ÌÑ¥ÌïúÎã§Í≥† Í∞ÄÏ†ï)
        const matched = Array.isArray(uomResp.data) ? uomResp.data[0] : uomResp.data;

        if (!matched || !matched.unitCode) throw new Error("Îã®ÏúÑÏΩîÎìú Ï°∞Ìöå Ïã§Ìå®");

        uomData = matched;
      } catch (err) {
        console.error("‚ùå Îã®ÏúÑÏΩîÎìú Ï°∞Ìöå Ïã§Ìå®:", err);
        return showToast("Îã®ÏúÑÏΩîÎìú Ï†ïÎ≥¥ ÌôïÏù∏ Ïã§Ìå®");
      }

      // ‚úÖ 2. Îã§Íµ≠Ïñ¥ Ïö∞ÏÑ†ÏàúÏúÑ Ï†ÅÏö© Ìï®Ïàò
      const getPreferredCommercialCode = (codes: any[] = []) => {
        const preferredLanguages = ['ko', 'en'];
        for (const lang of preferredLanguages) {
          const match = codes.find((c: any) => c.language === lang);
          if (match?.commercialCode) return match.commercialCode;
        }
        return codes[0]?.commercialCode || baseUnitOfMeasure;
      };

      // ‚úÖ 3. Îã®ÏúÑ Ï†ïÎ≥¥ Íµ¨ÏÑ±
      const unitOfMeasure = {
        commercialUnitOfMeasure: getPreferredCommercialCode(uomData?.commercialCodes),
        internalUnitOfMeasure: baseUnitOfMeasure,
        isoUnitOfMeasure: uomData?.isoCode || baseUnitOfMeasure
      };



        // // 3. SAP GoodsReceipt Ìò∏Ï∂ú
        // await callSapPostGoodsReceipt({
        //   plant: plant_cd,
        //   order: orderNumber,
        //   lineItems: [
        //     {
        //       material: materialCode,
        //       materialVersion: materialVersion,
        //       postingDate: workDate,
        //       quantity: {
        //         unitOfMeasure,
        //         value: quantityValue
        //       },
        //       sfc: rawSfc,
        //       storageLocation: storageLocation
        //     }
        //   ]
        // });

      // üìå 1. SAP ÏûÖÍ≥† Îì±Î°ù Ìò∏Ï∂ú
      const response = await callSapPostGoodsReceipt({
        plant: plant_cd,
        order: orderNumber,
        postedBy: "dmc_services_user",
        lineItems: [
          {
            material: materialCode,
            materialVersion,
            postingDate: workDate,
            quantity: {
              unitOfMeasure: {
                commercialUnitOfMeasure: "PR",
                internalUnitOfMeasure: "PR",
                isoUnitOfMeasure: "PR1"
              },
              value: quantityValue
            },
            sfc: rawSfc,
            storageLocation
          }
        ]
      });

    // üìå 2. ÏùëÎãµÏóêÏÑú transactionId Ï∂îÏ∂ú
    console.log("üì• SAP ÏùëÎãµ ÏõêÎ≥∏ ÌôïÏù∏:", response); // üëà Ï†ÑÏ≤¥ ÏùëÎãµ ÌôïÏù∏
    console.log("üì¶ lineItems ÌôïÏù∏:", response?.lineItems); // üëà lineItems ÌôïÏù∏

    const transactionIds = Array.isArray(response?.lineItems)
      ? response.lineItems
          .filter((item: any) => item?.transactionId && !item?.hasError)
          .map((item: any) => item.transactionId)
      : [];

    console.log("üîç Ï∂îÏ∂úÎêú transactionIds:", transactionIds); // üëà Ï∂îÏ∂ú Í≤∞Í≥º ÌôïÏù∏

    if (!transactionIds.length) {
      console.error("‚ùå Ïú†Ìö®Ìïú Ìä∏ÎûúÏû≠ÏÖò ID ÏóÜÏùå ‚Üí Ï°∞Ìöå Ï§ëÎã®");
      return;
    }



        // // ‚úÖ Ïù¥ÌõÑ insert ÎòêÎäî Îã§Ïùå Ï≤òÎ¶¨
        // await insertToNextStep();




      //   const goodsReceiptTasks = filtered
      //   .filter((item) => item.confirm_YN === "P")
      //   .map((item) => limit(async () => {
      //     try {
      //       const quantityValue = item.qty;
      //       const rawSfc = String(data.SFC ?? "").slice(0, 128);
      //       const orderNumber = String(data.ORDER_NUMBER ?? "").slice(0, 12);
      //       const workDate = work_date;
      //       const storageLocation = String(data.PUTAWAYSTORAGELOCATION ?? "").slice(0, 10);
      //       const materialCode = data.MATERIAL_CODE;
      //       const materialVersion = data.MATERIAL_VERSION || "ERP001";

      //       const unitOfMeasure = {
      //         commercialUnitOfMeasure: getPreferredCommercialCode(uomData?.commercialCodes),
      //         internalUnitOfMeasure: baseUnitOfMeasure,
      //         isoUnitOfMeasure: uomData?.isoCode || baseUnitOfMeasure,
      //       };

      //       await callSapPostGoodsReceipt({
      //         plant: plant_cd,
      //         order: orderNumber,
      //         lineItems: [
      //           {
      //             material: materialCode,
      //             materialVersion: materialVersion,
      //             postingDate: workDate,
      //             quantity: {
      //               unitOfMeasure,
      //               value: quantityValue,
      //             },
      //             sfc: rawSfc,
      //             storageLocation: storageLocation,
      //           },
      //         ],
      //       });

      //       console.log(`‚úÖ GoodsReceipt ÏôÑÎ£å - SFC: ${rawSfc}, QTY: ${quantityValue}`);
      //     } catch (err) {
      //       console.warn("‚ùå SAP GoodsReceipt Ïã§Ìå®:", err);
      //     }
      //   }));

      // // üîÅ Î≥ëÎ†¨ Ï≤òÎ¶¨ Ïã§Ìñâ
      // await Promise.all(goodsReceiptTasks);

        // 4. SAP ÏàòÎüâÌôïÏ†ï(Quantity Confirmation) Ìò∏Ï∂ú
        try {
          // const sfcStatusResp = await axios.get("http://localhost:4000/api/mssql/sfc-status", {
          //   params: { sfc: data.SFC }
          // });

          // const statusCode = sfcStatusResp.data.status;
          // const isFinal = statusCode === "405";

          // if (isFinal) {
          // console.log(`‚úÖ SFC ÏÉÅÌÉú 405 ‚Üí SAP Final Ï≤òÎ¶¨ ÏãúÏûë (status: ${statusCode})`);
          // } else {
          //   console.log(`‚è≠Ô∏è SFC ÏÉÅÌÉúÍ∞Ä 405 ÏïÑÎãò ‚Üí ÏùºÎ∞ò Quantity Confirm Ï≤òÎ¶¨ (status: ${statusCode})`);
          // }
         // ‚úÖ SFC ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï°∞Ìöå (Ï¥ù ÏàòÎüâÎßå ÏÇ¨Ïö©)
          // const sfcDetail_final = await fetchSfcDetail(plant_cd, String(data.SFC).slice(0, 128));
          // const totalQuantity = Number(sfcDetail_final.quantity ?? 0);



        // 1. Ï†ÑÏ≤¥ POSTED_TO_TARGET_SYS ÏûÖÍ≥† Îç∞Ïù¥ÌÑ∞ Ï°∞Ìöå
          const allPostedReceipts = await fetchPostedGoodsReceipts(
            plant_cd,
            orderNumber,
            rawSfc,
            materialCode,
            transactionIds
          );

          // 2. TxID Îß§Ïπ≠ Ïó¨Î∂Ä
          const postedMatchedTxIds = new Set<string>(
            allPostedReceipts
              .filter((gr: any) => transactionIds.includes(gr.transactionId?.trim?.()))
              .map((gr: any) => gr.transactionId?.trim?.())
          );

          // 3. Ï†ÑÏ≤¥ POSTED ÏàòÎüâ Ï§ë TxIDÏôÄ **Í≤πÏπòÏßÄ ÏïäÎäî Í≤ÉÎßå** Ìï©ÏÇ∞
          const postedQty = allPostedReceipts
            .filter((gr: any) => !postedMatchedTxIds.has(gr.transactionId?.trim?.()))
            .reduce((sum, gr) => sum + Number(gr.quantityInBaseUnit?.value ?? 0), 0);

          // 4. TxIDÏóê Ìï¥ÎãπÌïòÎäî ÌòÑÏû¨ Ï≤òÎ¶¨ Ï§ë ÏàòÎüâ
          const currentProcessingQty = allPostedReceipts
            .filter((gr: any) => postedMatchedTxIds.has(gr.transactionId?.trim?.()))
            .reduce((sum, gr) => sum + Number(gr.quantityInBaseUnit?.value ?? 0), 0);

          // 5. Ï¥ù ÏàòÎüâ Í≥ÑÏÇ∞
          const totalDone = Math.round((postedQty + currentProcessingQty) * 1000) / 1000;
          const isFinal = Math.abs(totalQuantity - totalDone) < 0.001;


        // 6. Í≤∞Í≥º Î°úÍ∑∏ Ï∂úÎ†•
        console.log("üì¶ ÏûÖÍ≥† ÎàÑÏ†Å ÏàòÎüâ Ï≤¥ÌÅ¨");
        console.log(`   üîπ Ï¥ù ÏàòÎüâ (SFC Í∏∞Ï§Ä): ${totalQuantity}`);
        console.log(`   üîπ ÎàÑÏ†Å ÏûÖÍ≥† ÏàòÎüâ (POSTED): ${postedQty}`);
        console.log(`   üîπ ÌòÑÏû¨ Ï≤òÎ¶¨ Ï§ë ÏàòÎüâ (TxID Îß§Ïπ≠): ${currentProcessingQty}`);
        console.log(`   üîπ ÎàÑÏ†Å Ìï©Í≥Ñ (Posted + ÏßÑÌñâÏ§ë): ${totalDone}`);
        console.log(`   üîπ ÏûîÎüâ: ${Math.max(0, totalQuantity - totalDone)}`);
        console.log(`   üîπ Final Ïó¨Î∂Ä: ${isFinal ? "‚úÖ Final" : "‚è≥ ÎØ∏ÏôÑÎ£å"}`);

        if (isFinal) {
          console.log("‚úÖ ÏûÖÍ≥† ÏàòÎüâÏù¥ Ï¥ù ÏàòÎüâÍ≥º ÎèôÏùº ‚Üí Final Ï≤òÎ¶¨Î°ú Í∞ÑÏ£º");
        } else {
          console.log("‚è≠Ô∏è ÏïÑÏßÅ ÏûÖÍ≥†ÎêòÏßÄ ÏïäÏùÄ ÏàòÎüâ ÏûàÏùå ‚Üí ÏùºÎ∞ò Confirm Ï≤òÎ¶¨");
        }






          // // ‚è± 1Ï¥à ÏßÄÏó∞ (TESTÏö©)
          // await new Promise(resolve => setTimeout(resolve, 2000));
          // ‚úÖ SAP Quantity Confirmation Ìò∏Ï∂ú (isFinalConfirmation Ï°∞Í±¥Î∂Ä Ï∂îÍ∞Ä)
          try {
            const qtyConfirmResp = await axios.post("http://localhost:4000/api/sap-post-qty-confirm", {
              plant: plant_cd,
              shopOrder: orderNumber,
              sfc: rawSfc,
              operationActivity: operation,
              workCenter: data.WORK_CENTER,
              yieldQuantity: quantityValue,
              yieldQuantityUnit: unitOfMeasure.internalUnitOfMeasure,
              yieldQuantityIsoUnit: unitOfMeasure.isoUnitOfMeasure,
              // isFinalConfirmation: false   // ‚úÖ ÎßàÏßÄÎßâ Ïπ¥ÎìúÏùº ÎïåÎßå Final Ï≤òÎ¶¨
              isFinalConfirmation: isFinal   // ‚úÖ ÎßàÏßÄÎßâ Ïπ¥ÎìúÏùº ÎïåÎßå Final Ï≤òÎ¶¨
            });

            console.log("‚úÖ Quantity Confirmation ÏÑ±Í≥µ:", qtyConfirmResp.data);
          } catch (qcErr) {
            const err = qcErr as any;
            console.error("‚ùå Quantity Confirmation Ïã§Ìå®:", err.response?.data || err.message);
          }

          // ‚úÖ Í∏∞Ï°¥ SAP End APIÎÇò FinalConfirm APIÎèÑ ÎÇ®Í≤®Ïïº Ìï† Í≤ΩÏö∞Îßå ÏïÑÎûò Ïú†ÏßÄ
          if (isFinal) {

            const postingDateTime = new Date(Date.now() - (10000 - index2 * 1000)).toISOString().replace(/\.\d{3}Z$/, ".000Z");
            // ‚úÖ 1. Auto Activity Confirmation Ìò∏Ï∂ú
            try {
              await callSapPostAutoConfirm({
                plant: plant_cd,
                shopOrder: orderNumber,
                sfc: rawSfc,
                operationActivity: operation,
                operationActivityVersion: operation_Version, // ÏÉùÎûµ Í∞ÄÎä•
                stepId: stepId ?? "",
                workCenter: data.WORK_CENTER,
                resource: resource,
                routingId: routing ?? "",
                finalConfirmation: true,
                postConfirmationToErp: true,
                postedBy: "dongil.kang@changshininc.com",
                postingDateTime: postingDateTime
              });

              console.log("‚úÖ AutoActivityConfirm ÏÑ±Í≥µ");
            } catch (autoErr) {
              const err = autoErr as any;
              console.error("‚ùå AutoActivityConfirm Ïã§Ìå®:", err.response?.data || err.message);
            }           
            // index2++; 
            // ‚úÖ 2. Í∏∞Ï°¥ Final Confirmation Î∞©Ïãù Ìò∏Ï∂ú
            try {
              const finalConfirmResp = await axios.post("http://localhost:4000/api/sap-post-final-confirm", {
                plant: plant_cd,
                shopOrder: orderNumber,
                sfc: rawSfc,
                operationActivity: operation
              });

              console.log("‚úÖ Final Quantity Confirmation ÏÑ±Í≥µ:", finalConfirmResp.data);
            } catch (finalErr) {
              const err = finalErr as any;
              console.error("‚ùå Final Quantity Confirmation Ïã§Ìå®:", err.response?.data || err.message);
            }
          }

        } catch (err) {
          console.error("‚ùå SFC ÏÉÅÌÉú ÌôïÏù∏ ÎòêÎäî SAP Ìò∏Ï∂ú Ïã§Ìå®:", err);
        }

      }
    }

    onClose();
  };

  // const handleSaveDetail = async () => {
  //   const changed = getModifiedRows(originalCardDataRef.current, cardData);
  //   const filtered = changed.filter(item => ["T", "P"].includes(item.confirm_YN));

  //   if (filtered.length === 0) return showToast("Î≥ÄÍ≤ΩÎêú Ïπ¥ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§.");
  //   const rawSfc = String(data?.SFC || "").slice(0, 128);

  //   if (!rawSfc) {
  //     console.error("‚ùå Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ SFC: null ÎòêÎäî Îπà Î¨∏ÏûêÏó¥ÏûÖÎãàÎã§.");
  //     showToast("SFC Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
  //     return;
  //   }
  //   //Sap Api Ìò∏Ï∂úÏùÑ ÏúÑÌïú ÌïÑÏàò Ï†ïÎ≥¥
  //    // üîç SAP SFC Detail Ï°∞Ìöå ‚Üí operation Í∞í ÎèôÏ†Å Ï∂îÏ∂ú
  //   const sfcDetail = await fetchSfcDetail(plant_cd, String(data.SFC).slice(0, 128));
  //   const routingCode = sfcDetail?.routing?.routing;
  //   const routingType = sfcDetail?.routing?.type === "SHOPORDER_SPECIFIC" ? "SHOP_ORDER" : sfcDetail?.routing?.type;

  //   const operation =
  //     sfcDetail?.status?.stepId ||
  //     sfcDetail?.steps?.[0]?.operation?.operation;

  //   if (!operation) {
  //     console.error("‚ùå operation Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
  //     throw new Error("SFCÏùò operation Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
  //   }

  //    // ‚úÖ SAP START Ìò∏Ï∂ú Ï°∞Í±¥: Î™®Îì† Ïπ¥ÎìúÏóê input_dt ÏóÜÏùÑ ÎïåÎßå
  //   const hasAnyInput = cardData.some(c => !!c.input_dt);
  //   if (!hasAnyInput) {
  //     const sapPayload = {
  //       plant: plant_cd.slice(0, 6),
  //       operation,
  //       resource: String(data.WORK_CENTER ?? "").slice(0, 36),
  //       // quantity: Number(data.QUANTITY ?? 0),
  //       // quantity: 0,
  //       sfcs: [String(data.SFC ?? "").slice(0, 128)],
  //       processLot: ""
  //     };
  //     await callSapStartApi(sapPayload);
  //   }

  //   //  // ‚úÖ Input ÏÉÅÌÉúÏù∏ Ïπ¥ÎìúÎßå SAP ASSEMBLE Ìò∏Ï∂ú
  //   // for (const item of filtered) {
  //   //   if (item.confirm_YN === "T") {
  //   //     await callSapPostAssembledComponent_auto({
  //   //       plant: plant_cd,
  //   //       sfc: String(data.SFC).slice(0, 128),
  //   //       operationActivity: operation,
  //   //       quantity: item.qty,
  //   //       resource: String(data.WORK_CENTER).slice(0, 36),
  //   //       hasTimeBased: true,
  //   //       hasNonTimeBased: true
  //   //     });
  //   //   }
  //   // }

  //   // ‚úÖ SAP POST Ìò∏Ï∂ú: I ÏÉÅÌÉúÏù∏ Ïπ¥ÎìúÎßå
  //   // 3. üì¶ SAP Routing API ÌÜµÌï¥ components Í∞ÄÏ†∏Ïò§Í∏∞
  //   let components: { component: string; componentVersion: string; quantity: number }[] = [];

  //   try {
  //     const routingResp = await axios.get("http://localhost:4000/api/sap/routing-detail", {
  //       params: {
  //         plant: plant_cd,
  //         routing: routingCode,
  //         type: routingType,
  //       }
  //     });

  //     // ‚úÖ SAP ÏùëÎãµÏùÄ Î∞∞Ïó¥ÏûÑ ‚Üí Ï≤´ Î≤àÏß∏ ÎùºÏö∞ÌåÖ Ï∂îÏ∂ú
  //     const routingData = Array.isArray(routingResp.data) ? routingResp.data[0] : routingResp.data;

  //     console.log("[RAW_ROUTING_DATA]", JSON.stringify(routingData, null, 2));

  //     const routingSteps = routingData?.routingSteps;

  //     if (!Array.isArray(routingSteps)) {
  //       console.warn("‚ùó routingSteps Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
  //       return showToast("SAP Routing Îã®Í≥Ñ Ï†ïÎ≥¥Í∞Ä ÏóÜÏäµÎãàÎã§.");
  //     }

  //     // ‚úÖ components Ï∂îÏ∂ú
  //     components = routingSteps
  //       .flatMap((step) => step.routingStepComponentList || [])
  //       .map((item): { component: string; componentVersion: string; quantity: number } | null => {
  //         const mat = item?.bomComponent?.material;
  //         const qty = item?.quantity;
  //         if (!mat || qty == null) return null;
  //         return {
  //           component: mat.material,
  //           componentVersion: mat.version,
  //           quantity: qty
  //         };
  //       })
  //       .filter((x): x is { component: string; componentVersion: string; quantity: number } => x !== null);

  //     console.log("üß© Ï∂îÏ∂úÎêú components:", components);

  //   } catch (err) {
  //     console.error("‚ùå Routing Detail Ï°∞Ìöå Ïã§Ìå®", err);
  //     return showToast("Routing ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î°úÎî© Ïã§Ìå®");
  //   }

  //   // 4. üîÅ SAP Assemble Ìò∏Ï∂ú (I ÏÉÅÌÉú)
  //   for (const item of filtered) {
  //     if (item.confirm_YN === "T") {
  //       for (const comp of components) {
  //         await callSapPostAssembledComponent({
  //           plant: plant_cd,
  //           sfc: rawSfc,
  //           operationActivity: operation,
  //           component: comp.component,
  //           componentVersion: comp.componentVersion,
  //           quantity: comp.quantity,
  //           resource: String(data.WORK_CENTER).slice(0, 36)
  //         });
  //       }
  //     }
  //   }

  //   // ‚úÖ ÏÑ†ÌÉùÌïú Ïπ¥ÎìúÍ∞Ä PÏùºÎïå complete SAP POST Ìò∏Ï∂ú
  //   for (const item of filtered) {
  //   if (item.confirm_YN === "P") {
  //     console.log("‚úÖ complete ÏßÑÏûÖ");
  //     const sapPayload = {
  //       plant: plant_cd.slice(0, 6),
  //       operation,
  //       resource: String(data.WORK_CENTER ?? "").slice(0, 36),
  //       quantity: item.qty,
  //       sfcs: [String(data.SFC ?? "").slice(0, 128)],
  //       processLot: ""
  //     };
  //     await callSapEndApi(sapPayload);
  //     }
  //   }

  //   const payload = filtered.map(item => ({

  //     PLANT_CD: plant_cd,  // ‚úÖ ÏΩ§Î≥¥ÏóêÏÑú ÎÑòÍ∏¥ Í∞í ÏÇ¨Ïö©
  //     WORK_CENTER: data.WORK_CENTER,
  //     ORDER_NUMBER: data.ORDER_NUMBER,
  //     SEQ: item.seq.toString(),
  //     MATERIAL_CODE: data.MATERIAL_CODE,
  //     SIZE_CD: data.SIZE_CD,
  //     ITPO_TYPE: item.confirm_YN,
  //     SFC: String(data.SFC).slice(0, 128)
  //   }));

  //   handlePostConfirm(payload);
  //   onConfirm?.(payload);
  //   onClose();
  // };

  const handleSaveAll = async () => {
    // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú SFCÎßå Ï†ÄÏû• ÎåÄÏÉÅ
    const currentSfc = minValidSfc;

    // 1. ÏÉÅÌÉú Ï†ÑÌôò Î°úÏßÅ Ï†ÅÏö© (Îã®Ïàú ÏÉÅÌÉúÍ∞íÎßå Î≥ÄÍ≤Ω)
    const updatedData = cardData.map(item => {
      if (item.mappedSFC === currentSfc) {
        if (item.confirm_YN === "N") {
          return { ...item, confirm_YN: "T" }; // ÌïòÏñÄÏÉâ ‚Üí ÌååÎûÄÏÉâ
        } else if (item.confirm_YN === "T") {
          return { ...item, confirm_YN: "P" }; // ÌååÎûÄÏÉâ ‚Üí Ï¥àÎ°ùÏÉâ ÌõÑÎ≥¥
        }
      }
      return item;
    });
    setCardData(updatedData); // ÏÉÅÌÉú Í∞±Ïã†


  // üîé ÌòÑÏû¨ SFCÏóê Ìï¥ÎãπÌïòÍ≥† T ÎòêÎäî P ÏÉÅÌÉúÏù∏ Ïπ¥ÎìúÎßå Ï∂îÏ∂ú
  const filtered = updatedData.filter(x =>
    x.mappedSFC === currentSfc &&
    ["T", "P"].includes(x.confirm_YN) &&
    x.flag !== "FINISH"
    
  );
console.log("üîç ÌïÑÌÑ∞ÎßÅÎêú Ïπ¥Îìú:", filtered);
  if (filtered.length === 0) {
    return showToast("ÌôïÏ†ï Í∞ÄÎä•Ìïú Ïπ¥ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§.");
  }

  // // ‚úÖ SAP API Ìò∏Ï∂úÏùÑ ÏúÑÌïú ÌïÑÏàò Ï†ïÎ≥¥
  // // üîç SAP SFC Detail Ï°∞Ìöå ‚Üí operation Ï∂îÏ∂ú
  // const sfcDetail = await fetchSfcDetail(plant_cd, String(currentSfc));
  // const operation =
  //   sfcDetail?.status?.stepId ||
  //   sfcDetail?.steps?.[0]?.operation?.operation;

  // if (!operation) {
  //   console.error("‚ùå operation Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.");
  //   return showToast("SFCÏùò operation Ï†ïÎ≥¥Î•º ÌôïÏù∏Ìï† Ïàò ÏóÜÏäµÎãàÎã§.");
  // }
  // const sfcCards = cardData.filter(x => x.mappedSFC === currentSfc);
  // const allInputMissing = sfcCards.every(x => !x.input_dt);

  // // ‚úÖ (1) SAP START Ìò∏Ï∂ú (Î™®Îì† Ïπ¥ÎìúÏóê input_dtÍ∞Ä ÏóÜÏùÑ ÎïåÎßå)
  // if (allInputMissing) {
  //   const sapPayload = {
  //     plant: plant_cd.slice(0, 6),
  //     operation,
  //     resource: String(data.WORK_CENTER ?? "").slice(0, 36),
  //     sfcs: [String(currentSfc)],
  //     processLot: ""
  //   };
  //   await callSapStartApi(sapPayload);
  // }

  // // ‚úÖ (2) SAP ASSEMBLE Ìò∏Ï∂ú (I ÏÉÅÌÉúÎßå)
  // for (const item of filtered) {
  //   if (item.confirm_YN === "I") {
  //     await callSapPostAssembledComponent_auto({
  //       plant: plant_cd,
  //       sfc: String(currentSfc),
  //       operationActivity: operation,
  //       quantity: item.qty,
  //       resource: String(data.WORK_CENTER).slice(0, 36),
  //       hasTimeBased: true,
  //       hasNonTimeBased: true
  //     });
  //   }
  // }

  // // ‚úÖ (3) SAP COMPLETE Ìò∏Ï∂ú (P ÏÉÅÌÉúÎßå)
  // for (const item of filtered) {
  //   if (item.confirm_YN === "P") {
  //     const completePayload = {
  //       plant: plant_cd.slice(0, 6),
  //       operation,
  //       resource: String(data.WORK_CENTER ?? "").slice(0, 36),
  //       quantity: item.qty,
  //       sfcs: [String(currentSfc)],
  //       processLot: ""
  //     };
  //     await callSapEndApi(completePayload);
  //   }
  // }
  // // ‚úÖ SAP API Ìò∏Ï∂úÏùÑ ÏúÑÌïú ÌïÑÏàò Ï†ïÎ≥¥


  // ‚úÖ (4) DB Ï†ÄÏû•
  const payload = filtered.map(item => ({
    PLANT_CD: plant_cd,
    WORK_CENTER: data.WORK_CENTER,
    ORDER_NUMBER: data.ORDER_NUMBER,
    SEQ: item.seq.toString(),
    MATERIAL_CODE: data.MATERIAL_CODE,
    SIZE_CD: data.SIZE_CD,
    ITPO_TYPE: item.confirm_YN,
    SFC: currentSfc
  }));

  try {
    await axios.post("http://localhost:4000/api/mssql/escan-detail-save", { list: payload });

    setCardData(prev =>
      prev.map(item =>
        payload.some(p => p.SEQ === item.seq.toString())
          ? { ...item, confirm_YN: "Y" }
          : item
      )
    );

    showToast("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.");
    onConfirm?.(payload);
    onClose();
  } catch (err) {
    showToast("‚ùå Ï†ÄÏû• Ï§ë Ïò§Î•ò Î∞úÏÉù");
  }
};

  // ‚úÖ mappedSFC Í∏∞Ï§ÄÏúºÎ°ú ÏÑ†ÌÉùÎêú SFCÏùò Ï¥ù ÏÉùÏÇ∞ ÏàòÎüâÏùÑ Í≥ÑÏÇ∞
  function calculateSfcTotalProdQty(sfc: string, cardList: CardItem[]): number {
    if (!sfc || !Array.isArray(cardList)) return 0;

    return cardList
      .filter((card) => card.mappedSFC === sfc)
      .reduce((sum, card) => sum + (Number(card.qty) || 0), 0);
  }


  const buttonStyle = {
    width: "120px",
    height: "90px",
    backgroundColor: "#333",
    color: "white",
    fontWeight: "bold",
    fontSize: "20px"
  };

  const cardBlock = (data: CardItem | null) => {
    if (!data) return <div style={{ height: "80px" }}></div>;

  const backgroundColor = getColorByStatus(data.confirm_YN);
  const clickable = isCardClickable(data);  // ‚úÖ mappedSFC === data.SFC Í∏∞Ï§Ä

    return (
      <div style={{ display: "flex", gap: "0.5rem", alignItems: "center", width: "100%", height: "80px", pointerEvents: clickable ? "auto" : "none"}}>
        <div style={{
          flex: 1,
          borderRadius: "10px",
          border: "none",
          backgroundColor,
          color: "black",
          fontWeight: "bold",
          display: "flex",
          flexDirection: "column",
          justifyContent: "space-between",
          padding: "6px",
          boxShadow: "inset 0 0 4px rgba(0,0,0,0.2)",
        }}>
          <div>
            PC SEQ : {data.seq} <br />
            Q'ty : {isNaN(data.qty) ? "-" : data.qty}
          </div>
          <div>
            Input : {data.input_dt || "-"} <br />
            Prod : {data.prod_dt || "-"}
          </div>
        </div>
        <img
          src={getImageByStatus(data.confirm_YN)}
          alt="OK"
          style={{
            width: "60px",
            height: "60px",
            borderRadius: "10px",
            cursor: clickable ? "pointer" : "not-allowed",
            opacity: clickable ? 1 : 0.4,
            objectFit: "contain",
            pointerEvents: clickable ? "auto" : "none"  // ‚úÖ Ïù¥Í±∞ Ï∂îÍ∞Ä!!!
          }}
          onClick={() => {
            if (!clickable) return;
            console.log("‚úÖ ÌÅ¥Î¶≠ ÌóàÏö©Îê®", data.seq);
            console.log("üîπ confirm_YN:", data.confirm_YN);
            handleDetailOk(data);
          }}
        />
      </div>
    );
  };

  return (
    <>
     <Toast open={toastOpen}>{toastMessage}</Toast>
      <Dialog
        open={open}
        onClose={onClose}
        style={{ width: "860px", height: "85vh", backgroundColor: "black", color: "white", overflowX: "hidden" }}>
        <div style={{ padding: "1rem" }}>
          <div style={{ display: "flex", justifyContent: "flex-start", gap: "1.6rem", marginBottom: "1rem" }}>
            <div style={{ backgroundColor: "black", color: "white", fontSize: "13px", minWidth: "220px" }}>
              <table style={{ width: "100%", borderCollapse: "collapse", tableLayout: "fixed", border: "1px solid white" }}>
                <tbody>
                  {Object.entries({
                    "Date": data?.WORK_DATE ?? "-",
                    "Line": data?.WORK_CENTER ?? "-",
                    "Model": data?.MODEL_CD ?? "-",
                    "Style": data?.STYLE_CD ?? "-",
                    "Material": data?.MATERIAL_CODE ?? "-",
                    "Description": data?.MATERIAL_DESCRIPTION ?? "-",
                    "SFC": data?.SFC ?? "-",
                    "Qty": data?.QUANTITY ?? "-",
                    "Size": data?.SIZE_CD ?? "-",
                    "Order No.": data?.ORDER_NUMBER ?? "-",
                    "Storage": data?.PUTAWAYSTORAGELOCATION ?? "-",
                  }).map(([key, value]) => (
                    <tr key={key}>
                      <td style={{ width: "100px", fontWeight: "bold", padding: "6px 8px", border: "1px solid white", backgroundColor: "black", color: "white", whiteSpace: "nowrap" }}>‚Ä¢ {key}</td>
                      <td style={{ padding: "6px 8px", border: "1px solid white", backgroundColor: "black", color: "white", whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>: {value}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div style={{ textAlign: "center", marginBottom: "1rem" }}>
              <Text style={{ fontSize: "3rem", color: "white", fontWeight: "bold",  marginTop: "-10px", marginBottom: "0.5rem",  }}>
                Do you want to <br /> confirm data?
              </Text>

              <div style={{
                display: "flex",
                justifyContent: "center",
                gap: "1.5rem",
                marginBottom: "1.7rem"
              }}>
                {filterOptions.map(({ key, label }) => {
                  const isChecked = checkedStates[key];
                  const backgroundColor = isChecked
                    ? key === "completed"
                      ? "limegreen"
                      : key === "notStarted"
                        ? "#d3d3d3"
                        : "dodgerblue"
                    : "#444";

                  return (
                    <label
                      key={key}
                      style={{
                        display: "flex",
                        alignItems: "center",
                        gap: "8px",
                        backgroundColor,
                        padding: "18px 15px",
                        borderRadius: "8px",
                        color: "white",
                        fontSize: "1.5rem",
                        cursor: "pointer",
                        border: isChecked ? "2px solid cyan" : "2px solid transparent",
                        transition: "border 0.2s, background-color 0.2s"
                      }}
                    >
                      <input
                        type="checkbox"
                        checked={isChecked}
                        onChange={(e) =>
                          setCheckedStates((prev) => ({
                            ...prev,
                            [key]: e.target.checked
                          }))
                        }
                        style={{
                          transform: "scale(1.8)",
                          cursor: "pointer",
                          width: "20px",
                          height: "20px",
                          accentColor: "cyan"
                        }}
                      />
                      {label}
                    </label>
                  );
                })}

              </div>




              <div style={{ display: "flex", justifyContent: "center", gap: "0.5rem" }}>
                <Button
                  icon={saveIcon}
                  className="detail-button"
                  onClick={handleSaveDetail}
                  disabled={!canSaveDetail} // Ï≤¥ÌÅ¨(ÏÉâ Î≥ÄÍ≤Ω)Îêú Ïπ¥ÎìúÍ∞Ä ÏóÜÏúºÎ©¥ ÎπÑÌôúÏÑ±Ìôî
                >
                  Save<br />Detail
                </Button>
                <Button
                  icon={saveIcon}
                  className="detail-button"
                  onClick={handleSaveAll}
                  disabled={!(canSaveAll)} // ÌïòÎÇòÎùºÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ Í∞ÄÎä• ÏÉÅÌÉúÍ∞Ä ÏóÜÏúºÎ©¥ ÎπÑÌôúÏÑ±Ìôî
                >
                  Save<br />All
                </Button>
                <Button icon="decline" className="detail-button detail-button-danger" onClick={onClose}>
                  Close
                </Button>
              </div>
            </div>
          </div>

          <div style={{ display: "flex", flexDirection: "column", gap: "0.5rem", marginLeft: "0px" }}>
            {rowsByColumns.map((row, rowIndex) => (
              <div key={rowIndex} style={{ display: "flex", justifyContent: "space-between", gap: "1rem" }}>
                {row.map((data, colIndex) => (
                  <div key={colIndex} style={{ flex: 1, minWidth: 0, overflow: "hidden" }}>
                    {data ? cardBlock(data) : <div style={{ height: "80px" }}></div>}
                  </div>
                ))}
              </div>
            ))}

          </div>

          {cardData.length > itemsPerPage && (
            <div style={{ marginTop: "1rem", textAlign: "center" }}>
              {Array.from({ length: totalPages }).map((_, idx) => {
                const pageNum = idx + 1;
                return (
                  <Button
                    key={pageNum}
                    onClick={() => setCurrentPage(pageNum)}
                    style={{
                      margin: "0 8px",
                      backgroundColor: currentPage === pageNum ? "cyan" : "#222",
                      color: "white",
                      borderRadius: "8px",
                      fontWeight: "bold"
                    }}
                  >
                    {pageNum}
                  </Button>
                );
              })}
            </div>
          )}


        </div>
      </Dialog>
    </>
  );
}

export default E_ScanOutgoing_Detail;
